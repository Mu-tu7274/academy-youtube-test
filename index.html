<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ØªØ´ØºÙŠÙ„ ÙŠÙˆØªÙŠÙˆØ¨ + Fetch Ø¹Ø¨Ø± Flutter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg-main: #050816;
      --bg-card: radial-gradient(circle at top, #1f1f49 0, #050816 40%, #02030a 100%);
      --border-soft: rgba(255, 255, 255, 0.12);
      --accent: #ffb347;
      --accent-strong: #ff6b3d;
      --text-main: #f5f5f5;
      --text-muted: #a8a8c0;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .shell {
      position: relative;
      width: 100%;
      max-width: 560px;
      border-radius: 20px;
      background: var(--bg-card);
      box-shadow: 0 20px 45px rgba(0, 0, 0, 0.75), 0 0 0 1px rgba(255, 255, 255, 0.05);
      padding: 20px 18px 18px;
    }

    .title { font-size: 18px; font-weight: 700; margin-bottom: 8px; text-align: center; }
    .subtitle { font-size: 13px; color: var(--text-muted); margin-bottom: 16px; text-align: center; }

    .token-label { font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }
    .token-box {
      width: 100%;
      min-height: 54px;
      border-radius: 14px;
      background: rgba(3, 7, 30, 0.9);
      border: 1px solid var(--border-soft);
      padding: 8px 10px;
      font-size: 12px;
      line-height: 1.5;
      overflow-wrap: break-word;
    }

    .btn {
      margin-top: 12px;
      width: 100%;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #050816;
      font-weight: 700;
      box-shadow: 0 10px 24px rgba(255, 107, 61, 0.35);
    }
    .btn-secondary {
      background: transparent;
      color: var(--text-main);
      border: 1px solid var(--border-soft);
      box-shadow: none;
      font-weight: 600;
    }
    .hidden { display: none; }

    .log {
      margin-top: 12px;
      font-size: 12px;
      color: #cfcfe6;
      opacity: 0.9;
      border: 1px dashed rgba(255,255,255,0.18);
      border-radius: 12px;
      padding: 10px;
      background: rgba(0,0,0,0.18);
      max-height: 160px;
      overflow: auto;
      white-space: pre-wrap;
    }

    .classic-btn{
      position: absolute;
      top: 14px;
      right: 14px;
      z-index: 10;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.25);
      color: var(--text-main);
      font-size: 12px;
      padding: 8px 12px;
      cursor: pointer;
      backdrop-filter: blur(6px);
    }
    .classic-btn:active { transform: scale(0.98); }

    /* ØµÙØ­Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© */
    .result-box {
      margin-top: 12px;
      border-radius: 14px;
      background: rgba(3, 7, 30, 0.65);
      border: 1px solid var(--border-soft);
      padding: 10px;
    }
    .result-title {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    pre.json-viewer {
      margin: 0;
      font-size: 12px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 280px;
      overflow: auto;
      direction: ltr;
      text-align: left;
      color: #eaeaff;
    }

    .loader {
      margin-top: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 12px;
      color: var(--text-muted);
    }
    .spinner {
      width: 18px;
      height: 18px;
      border: 3px solid rgba(255,255,255,0.18);
      border-top-color: rgba(255,255,255,0.85);
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>
  <div class="shell">

    <button id="classicModeBtn" class="classic-btn" type="button">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ</button>

    <!-- PAGE 1 -->
    <div id="page1">
      <div class="title">ØªØ´ØºÙŠÙ„ ÙŠÙˆØªÙŠÙˆØ¨ Ù…Ø¹Ù†Ø§</div>
      <div class="subtitle">Ø§Ø¶ØºØ· Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ´ØºÙŠÙ„ / Ø§Ù„ÙÙŠØªØ´.</div>

      <div class="token-label">authToken Ù…Ù† localStorage</div>
      <div id="tokenBoxPage1" class="token-box">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙˆÙƒÙ†...</div>

      <button id="goToPage2" class="btn">Ø§Ù„ØªØ§Ù„ÙŠ â–¶</button>
      <div id="log1" class="log"></div>
    </div>

    <!-- PAGE 2 -->
    <div id="page2" class="hidden">
      <div class="title">Ø®Ø·ÙˆØ© Ø§Ù„ØªØ´ØºÙŠÙ„</div>
      <div class="subtitle">Ø§Ø®ØªØ± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ø¹Ø¨Ø± Flutter</div>

      <div class="token-label">authToken Ù…Ù† localStorage</div>
      <div id="tokenBoxPage2" class="token-box">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙˆÙƒÙ†...</div>

      <button id="openYoutube" class="btn">ØªØ´ØºÙŠÙ„ ÙŠÙˆØªÙŠÙˆØ¨ (Watch) â–¶</button>
      <button id="openYoutubeEmbedDirect" class="btn btn-secondary">ØªØ´ØºÙŠÙ„ ÙŠÙˆØªÙŠÙˆØ¨ (Embedded Ù…Ø¨Ø§Ø´Ø±) â–¶</button>

      <!-- âœ… Ø§Ù„Ø²Ø± Ø§Ù„Ù„ÙŠ Ø¨ÙŠÙ†Ù‚Ù„Ùƒ Ù„ØµÙØ­Ø© Ø§Ù„ÙÙŠØªØ´ -->
      <button id="goToFetchPage" class="btn btn-secondary">Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Flutter) ğŸ“¥</button>

      <button id="backToPage1" class="btn btn-secondary">Ø±Ø¬ÙˆØ¹</button>
      <div id="log2" class="log"></div>
    </div>

    <!-- PAGE 3: Fetch via Flutter -->
    <div id="page3" class="hidden">
      <div class="title">Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</div>
      <div class="subtitle">Ø³ÙŠØªÙ… Ø¹Ù…Ù„ Ø§Ù„ÙÙŠØªØ´ Ø¹Ø¨Ø± Flutter Ù„ØªØ¬Ù†Ø¨ CORS</div>

      <div class="loader" id="loader">
        <span class="spinner"></span>
        <span>Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</span>
      </div>

      <div id="fetchResultBox" class="result-box hidden">
        <div class="result-title">Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙÙŠØªØ´</div>
        <pre id="fetchResultPre" class="json-viewer"></pre>
      </div>

      <button id="retryFetch" class="btn btn-secondary">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ğŸ”</button>
      <button id="backToPage2" class="btn btn-secondary">Ø±Ø¬ÙˆØ¹</button>

      <div id="log3" class="log"></div>
    </div>

  </div>

<script>
(function () {
  "use strict";

  const YOUTUBE_WATCH_URL = "https://www.youtube.com/watch?v=m-VVub8Jp_w";
  const YOUTUBE_EMBED_URL = "https://www.youtube.com/embed/m-VVub8Jp_w?autoplay=1&playsinline=1";

  function el(id){ return document.getElementById(id); }

  function activeLogEl() {
    if (!el("page3").classList.contains("hidden")) return el("log3");
    if (!el("page2").classList.contains("hidden")) return el("log2");
    return el("log1");
  }

  function log(msg) {
    const box = activeLogEl();
    const line = `[${new Date().toLocaleTimeString()}] ${msg}\n`;
    if (box) box.textContent = (box.textContent + line).slice(-4000);
  }

  function setTokenBoxes() {
    const token = localStorage.getItem("authToken") || "(Ù„Ø§ ÙŠÙˆØ¬Ø¯ authToken)";
    if (el("tokenBoxPage1")) el("tokenBoxPage1").textContent = token;
    if (el("tokenBoxPage2")) el("tokenBoxPage2").textContent = token;
  }

  function showPage(n) {
    ["page1","page2","page3"].forEach(id => el(id).classList.add("hidden"));
    el("page" + n).classList.remove("hidden");
    setTokenBoxes();
    log("â¡ï¸ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© " + n);
  }

  /* classic mode -> Flutter */
  function notifyFlutterClassicMode(payload) {
    try {
      if (window.flutter_inappwebview && window.flutter_inappwebview.callHandler) {
        window.flutter_inappwebview.callHandler("classicMode", payload);
        log("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ classicMode Ù„Ù€ Flutter");
      } else {
        log("â„¹ï¸ flutter_inappwebview ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (ØªØ¬Ø±Ø¨Ø© Ù…ØªØµÙØ­ Ø¹Ø§Ø¯ÙŠ)");
      }
    } catch (e) {
      log("âš ï¸ classicMode error: " + (e && e.message ? e.message : e));
    }
  }

  /* âœ… Fetch Ø¹Ø¨Ø± Flutter handler: fetchDownr */
  async function fetchDownrViaFlutter(url) {
    const loader = el("loader");
    const box = el("fetchResultBox");
    const pre = el("fetchResultPre");

    if (loader) loader.classList.remove("hidden");
    if (box) box.classList.add("hidden");
    if (pre) pre.textContent = "";

    try {
      if (!(window.flutter_inappwebview && window.flutter_inappwebview.callHandler)) {
        log("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ flutter_inappwebview.callHandler â€” Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ØªØ­ØªØ§Ø¬ WebView Ø¯Ø§Ø®Ù„ Flutter");
        if (loader) loader.classList.add("hidden");
        if (box) box.classList.remove("hidden");
        if (pre) pre.textContent = JSON.stringify({
          ok: false,
          error: "flutter_inappwebview.callHandler not available"
        }, null, 2);
        return;
      }

      log("ğŸ“¡ Ø·Ù„Ø¨ fetchDownr Ù…Ù† Flutter...");
      const result = await window.flutter_inappwebview.callHandler("fetchDownr", { url });

      log("âœ… Flutter Ø±Ø¬Ù‘Ø¹ Ù†ØªÙŠØ¬Ø©");
      if (loader) loader.classList.add("hidden");
      if (box) box.classList.remove("hidden");

      // Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
      if (pre) pre.textContent = JSON.stringify(result, null, 2);

    } catch (e) {
      log("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ callHandler(fetchDownr): " + (e && e.message ? e.message : e));
      if (loader) loader.classList.add("hidden");
      if (box) box.classList.remove("hidden");
      if (pre) pre.textContent = JSON.stringify({
        ok: false,
        error: (e && e.message) ? e.message : String(e)
      }, null, 2);
    }
  }

  function bindHandlers() {
    setTokenBoxes();
    log("âœ… bindHandlers Ø§Ø´ØªØºÙ„");

    const classicBtn = el("classicModeBtn");
    const goToPage2 = el("goToPage2");
    const backToPage1 = el("backToPage1");
    const backToPage2 = el("backToPage2");
    const btnWatch = el("openYoutube");
    const btnEmbed = el("openYoutubeEmbedDirect");
    const goFetchPage = el("goToFetchPage");
    const retryFetch = el("retryFetch");

    if (classicBtn) {
      classicBtn.addEventListener("click", () => {
        try {
          localStorage.setItem("classic_mode", "true");
          log("âœ… classic_mode=true saved to localStorage");
          notifyFlutterClassicMode({ classic_mode: true, ts: Date.now() });
        } catch (e) {
          log("âŒ classic mode error: " + (e && e.message ? e.message : e));
        }
      });
    }

    if (goToPage2) goToPage2.addEventListener("click", () => showPage(2));
    if (backToPage1) backToPage1.addEventListener("click", () => showPage(1));
    if (backToPage2) backToPage2.addEventListener("click", () => showPage(2));

    if (btnWatch) btnWatch.addEventListener("click", () => {
      log("ğŸš€ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Watch: " + YOUTUBE_WATCH_URL);
      window.location.assign(YOUTUBE_WATCH_URL);
    });

    if (btnEmbed) btnEmbed.addEventListener("click", () => {
      log("ğŸš€ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Embed: " + YOUTUBE_EMBED_URL);
      window.location.assign(YOUTUBE_EMBED_URL);
    });

    // âœ… Ø²Ø± ÙŠÙØªØ­ ØµÙØ­Ø© 3 ÙˆÙŠØ¨Ø¯Ø£ Ø§Ù„ÙÙŠØªØ´ ØªÙ„Ù‚Ø§Ø¦ÙŠ
    if (goFetchPage) goFetchPage.addEventListener("click", () => {
      showPage(3);
      fetchDownrViaFlutter(YOUTUBE_WATCH_URL);
    });

    // âœ… Retry
    if (retryFetch) retryFetch.addEventListener("click", () => {
      showPage(3);
      fetchDownrViaFlutter(YOUTUBE_WATCH_URL);
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", bindHandlers);
  } else {
    bindHandlers();
  }

  // fallback
  setTimeout(() => { try { bindHandlers(); } catch(_) {} }, 250);

})();
</script>

</body>
</html>
